<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SudokuKu ‚Äî Profil</title>
  <meta name="theme-color" content="#667eea">
  <link rel="stylesheet" href="/css/gaya.css">
</head>
<body>
  <header class="header">
    <nav class="navbar">
      <div class="logo">üéÆ SudokuKu</div>
      <ul class="nav-menu">
        <li><a href="/">Beranda</a></li>
        <li><a href="/sudoku">Main</a></li>
        <li><a href="/leaderboard">Leaderboard</a></li>
        <li><a href="/profil" style="color: #667eea; font-weight: bold;">Profil (<%= namaLengkap %>)</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <div class="card" style="max-width:900px; margin:2rem auto;">
      <div class="card-header text-center" style="position:relative; padding-bottom:1rem;">
        <h1 class="card-title">üë§ Profil Saya</h1>
        <p class="card-subtitle">Informasi akun dan riwayat permainan</p>
        <div style="margin-top:0.75rem;">
          <a href="/api/logout" onclick="return confirm('Yakin ingin logout?')" class="btn btn-danger">üö™ Logout</a>
        </div>
      </div>

      <div id="profil-info" style="padding:1.5rem; display:grid; grid-template-columns: 1fr; gap:1rem;">
        <div class="card" style="padding:1.25rem;">
          <h3>Data Akun</h3>
          <p><strong>Nama:</strong> <span id="nama-lengkap"><%= namaLengkap %></span></p>
          <p><strong>Email:</strong> <span id="email">-</span></p>
          <p><strong>Tanggal Daftar:</strong> <span id="tanggal-daftar">-</span></p>
          <p><strong>Skor Terbaik:</strong> <span id="skor-terbaik">-</span></p>
          <p><strong>Total Permainan:</strong> <span id="total-permainan">-</span></p>
        </div>
      </div>

      <div style="padding:1.5rem;">
        <h3>Riwayat Skor</h3>
        <div style="overflow:auto;">
          <table class="leaderboard-table" style="width:100%;">
            <thead>
              <tr>
                <th>#</th>
                <th>Tanggal</th>
                <th>Tingkat</th>
                <th>Waktu</th>
                <th>Skor</th>
                <th>Selesai</th>
              </tr>
            </thead>
            <tbody id="riwayat-body">
              <tr><td colspan="6">Memuat riwayat...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    function formatWaktu(detiks) {
      const m = Math.floor(detiks / 60).toString().padStart(2, '0');
      const s = (detiks % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function formatTanggal(iso) {
      const d = new Date(iso);
      return d.toLocaleString();
    }

    async function muatProfil() {
      try {
        const res = await fetch('/api/profil');
        if (!res.ok) throw new Error('Gagal memuat profil');
        const json = await res.json();
        if (!json.sukses) throw new Error(json.pesan || 'Tidak sukses');

        const data = json.data;
        document.getElementById('email').innerText = data.email || '-';
        document.getElementById('tanggal-daftar').innerText = data.tanggalDaftar ? new Date(data.tanggalDaftar).toLocaleDateString() : '-';
        document.getElementById('terakhir-login').innerText = data.terakhirLogin ? new Date(data.terakhirLogin).toLocaleString() : '-';
        document.getElementById('skor-terbaik').innerText = data.skorTerbaik || '-';
        document.getElementById('total-permainan').innerText = data.totalPermainan || 0;

        document.getElementById('ringkasan').innerText = `Skor terbaik: ${data.skorTerbaik || '-'} ¬∑ Total permainan: ${data.totalPermainan || 0}`;
      } catch (err) {
        console.error(err);
        document.getElementById('ringkasan').innerText = 'Gagal memuat ringkasan profil.';
      }
    }

    async function muatRiwayat() {
      try {
        const res = await fetch('/api/riwayat-skor');
        const body = document.getElementById('riwayat-body');
        body.innerHTML = '';
        let json;
        try {
          json = await res.json();
        } catch (e) {
          body.innerHTML = '<tr><td colspan="6">Gagal memuat riwayat (response bukan JSON)</td></tr>';
          return;
        }

        if (!res.ok || !json.sukses) {
          const pesan = json.pesan || json.error || 'Gagal memuat riwayat';
          body.innerHTML = `<tr><td colspan="6">Gagal memuat riwayat: ${pesan}</td></tr>`;
          return;
        }

        if (!json.data || json.data.length === 0) {
          body.innerHTML = '<tr><td colspan="6">Belum ada riwayat permainan</td></tr>';
          return;
        }

        json.data.forEach((r, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${formatTanggal(r.tanggalMain)}</td>
            <td>${r.tingkatKesulitan}</td>
            <td>${formatWaktu(r.waktuPenyelesaian)}</td>
            <td>${r.skor}</td>
            <td>${r.apakahSelesai ? '‚úÖ' : '‚ùå'}</td>
          `;
          body.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        const body = document.getElementById('riwayat-body');
        body.innerHTML = `<tr><td colspan="6">Gagal memuat riwayat: ${err.message}</td></tr>`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
        muatProfil();
      muatRiwayat();
        // Tampilkan skor beserta level dalam satu field
        function tingkatDariSkor(skor) {
          if (!skor || skor <= 0) return null;
          if (skor >= 300) return 'Sulit';
          if (skor >= 200) return 'Sedang';
          return 'Mudah';
        }

        (function setSkorDanLevel() {
          try {
            const elemSkor = document.getElementById('skor-terbaik');
            const skorVal = Number(document.getElementById('skor-terbaik').innerText) || null;
            // jika muatProfil sudah mengisi nilai, gunakan itu; jika belum, coba fetch cepat
            if (skorVal && skorVal > 0) {
              const level = tingkatDariSkor(skorVal);
              elemSkor.innerText = `${skorVal} ${level ? `(${level})` : ''}`;
              return;
            }

            // fetch as fallback (safe and idempotent)
            fetch('/api/profil').then(r => r.json()).then(json => {
              if (!json || !json.sukses) return;
              const skor = json.data.skorTerbaik || 0;
              const level = tingkatDariSkor(skor);
              elemSkor.innerText = skor && skor > 0 ? `${skor} ${level ? `(${level})` : ''}` : '-';
              // ensure total permainan also set if missing
              const tp = document.getElementById('total-permainan');
              if (tp && (tp.innerText === '-' || !tp.innerText)) tp.innerText = json.data.totalPermainan || 0;
            }).catch(() => {});
          } catch (e) {
            // ignore
          }
        })();
    });
  </script>
</body>
</html>