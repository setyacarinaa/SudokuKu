<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SudokuKu ‚Äî Profil</title>
  <meta name="theme-color" content="#667eea">
  <link rel="stylesheet" href="/css/gaya.css">
</head>
<body>
  <header class="header">
    <nav class="navbar">
      <div class="logo">üéÆ SudokuKu</div>
      <ul class="nav-menu">
        <li><a href="/">Beranda</a></li>
        <li><a href="/sudoku">Main</a></li>
        <li><a href="/leaderboard">Leaderboard</a></li>
        <li><a href="/profil" style="color: #667eea; font-weight: bold;">Profil (<%= namaLengkap %>)</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <div class="card" style="max-width:900px; margin:2rem auto;">
      <div class="card-header text-center" style="position:relative; padding-bottom:1rem;">
        <h1 class="card-title">üë§ Profil Saya</h1>
        <p class="card-subtitle">Informasi akun dan riwayat permainan</p>
        <div style="margin-top:0.75rem;">
          <a href="/api/logout" onclick="return confirm('Yakin ingin logout?')" class="btn btn-danger">üö™ Logout</a>
        </div>
      </div>

      <div id="profil-info" style="padding:1.5rem; display:grid; grid-template-columns: 1fr; gap:1rem;">
        <div class="card" style="padding:1.25rem;">
          <h3>Data Akun</h3>
          <p><strong>Nama:</strong> <span id="nama-lengkap"><%= namaLengkap %></span></p>
          <p><strong>Email:</strong> <span id="email">-</span></p>
          <p><strong>Tanggal Daftar:</strong> <span id="tanggal-daftar">-</span></p>
          <p><strong>Skor Terbaik:</strong> <span id="skor-terbaik">-</span></p>
          <p><strong>Total Permainan:</strong> <span id="total-permainan">-</span></p>
          <p id="ringkasan" style="margin-top:0.5rem; color:#444;">Skor terbaik: - ¬∑ Total permainan: -</p>
        </div>
      </div>

      <div style="padding:1.5rem;">
        <h3>Riwayat Skor</h3>
        <div style="overflow:auto;">
          <table class="leaderboard-table" style="width:100%;">
            <thead>
              <tr>
                <th>#</th>
                <th>Tanggal</th>
                <th>Tingkat</th>
                <th>Waktu</th>
                <th>Skor</th>
                <th>Selesai</th>
              </tr>
            </thead>
            <tbody id="riwayat-body">
              <tr><td colspan="6">Memuat riwayat...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    function formatWaktu(detiks) {
      const m = Math.floor(detiks / 60).toString().padStart(2, '0');
      const s = (detiks % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function formatTanggal(iso) {
      const d = new Date(iso);
      return d.toLocaleString();
    }

    async function muatProfil() {
      // initialize placeholders first
      const setIf = (id, value) => { const el = document.getElementById(id); if (el) el.innerText = value; };
      setIf('email', '-');
      setIf('tanggal-daftar', '-');
      setIf('terakhir-login', '-');
      setIf('skor-terbaik', '-');
      setIf('total-permainan', '-');
      const ringEl = document.getElementById('ringkasan');
      if (ringEl) ringEl.innerText = 'Memuat ringkasan...';

      try {
        const res = await fetch('/api/profil', { credentials: 'include', headers: { 'Accept': 'application/json' } });
        if (!res.ok) {
          const t = await res.text().catch(() => '');
          const reason = t || res.statusText || `Status ${res.status}`;
          if (ringEl) ringEl.innerText = 'Gagal memuat ringkasan: ' + reason;
          return false;
        }
        const json = await res.json().catch(() => null);
        if (!json || !json.sukses) {
          const pesan = (json && (json.pesan || json.error)) || 'Tidak sukses';
          if (ringEl) ringEl.innerText = 'Gagal memuat ringkasan: ' + pesan;
          return false;
        }

        const data = json.data || {};
        setIf('email', data.email || '-');
        setIf('tanggal-daftar', data.tanggalDaftar ? new Date(data.tanggalDaftar).toLocaleDateString() : '-');
        setIf('terakhir-login', data.terakhirLogin ? new Date(data.terakhirLogin).toLocaleString() : '-');
        setIf('skor-terbaik', data.skorTerbaik || '-');
        setIf('total-permainan', data.totalPermainan || 0);
        if (ringEl) ringEl.innerText = `Skor terbaik: ${data.skorTerbaik || '-'} ¬∑ Total permainan: ${data.totalPermainan || 0}`;
      } catch (err) {
        console.error(err);
        if (ringEl) ringEl.innerText = 'Gagal memuat ringkasan profil.';
        return false;
      }
    }

    async function muatRiwayat() {
      try {
        const body = document.getElementById('riwayat-body');
        if (!body) return;
        body.innerHTML = '<tr><td colspan="6">Memuat riwayat...</td></tr>';

        const fetchRiwayat = async () => {
          const res = await fetch('/api/riwayat-skor', { credentials: 'include', headers: { 'Accept': 'application/json' } });
          const ct = res.headers.get('content-type') || '';
          let json = null;
          if (ct.includes('application/json')) json = await res.json().catch(() => null);
          if (!res.ok) {
            const pesan = (json && (json.pesan || json.error)) || res.statusText || `Status ${res.status}`;
            return { ok: false, pesan, status: res.status, json };
          }
          if (!json || !json.sukses) {
            const pesan = (json && (json.pesan || json.error)) || 'Gagal memuat riwayat';
            return { ok: false, pesan, status: res.status, json };
          }
          return { ok: true, data: json.data };
        };

        // attempt once, retry once after refreshing profile if unauthorized/runs-into-login requirement
        let attempt = 0;
        let result = await fetchRiwayat();
        if (!result.ok && (result.status === 401 || /login/i.test(result.pesan || ''))) {
          // if server says login required but page shows a logged-in name, try refreshing session endpoint and retry once
          const nameEl = document.getElementById('nama-lengkap');
          if (nameEl && nameEl.innerText && nameEl.innerText.trim()) {
            try { await fetch('/api/profil', { credentials: 'include', headers: { 'Accept': 'application/json' } }); } catch (e) { /* ignore */ }
            attempt++;
            result = await fetchRiwayat();
          }
        }

        if (!result.ok) {
          body.innerHTML = `<tr><td colspan="6">Gagal memuat riwayat: ${result.pesan}</td></tr>`;
          return;
        }

        const data = result.data;
        if (!data || data.length === 0) {
          body.innerHTML = '<tr><td colspan="6">Belum ada riwayat permainan</td></tr>';
          return;
        }

        body.innerHTML = '';
        data.forEach((r, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${formatTanggal(r.tanggalMain)}</td>
            <td>${r.tingkatKesulitan}</td>
            <td>${formatWaktu(r.waktuPenyelesaian)}</td>
            <td>${r.skor}</td>
            <td>${r.apakahSelesai ? '‚úÖ' : '‚ùå'}</td>
          `;
          body.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        const body = document.getElementById('riwayat-body');
        if (body) body.innerHTML = `<tr><td colspan="6">Gagal memuat riwayat: ${err.message}</td></tr>`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
        (async function initProfile() {
          const ok = await muatProfil();
          // load riwayat after profil attempt to avoid race/unauthorized issues
          await muatRiwayat();
        })();
        // Tampilkan skor beserta level dalam satu field
        function tingkatDariSkor(skor) {
          if (!skor || skor <= 0) return null;
          if (skor >= 300) return 'Sulit';
          if (skor >= 200) return 'Sedang';
          return 'Mudah';
        }

        (function setSkorDanLevel() {
          try {
            const elemSkor = document.getElementById('skor-terbaik');
            const raw = elemSkor ? elemSkor.innerText : '';
            const skorVal = raw ? Number(raw.toString().replace(/[^0-9.-]+/g, '')) || null : null;
            // jika muatProfil sudah mengisi nilai, gunakan itu; jika belum, coba fetch cepat
            if (skorVal && skorVal > 0) {
              const level = tingkatDariSkor(skorVal);
              elemSkor.innerText = `${skorVal} ${level ? `(${level})` : ''}`;
              return;
            }

            // fetch as fallback (safe and idempotent)
            fetch('/api/profil', { credentials: 'include' }).then(r => r.json()).then(json => {
              if (!json || !json.sukses) return;
              const skor = json.data.skorTerbaik || 0;
              const level = tingkatDariSkor(skor);
              if (elemSkor) elemSkor.innerText = skor && skor > 0 ? `${skor} ${level ? `(${level})` : ''}` : '-';
              // ensure total permainan also set if missing
              const tp = document.getElementById('total-permainan');
              if (tp && (tp.innerText === '-' || !tp.innerText)) tp.innerText = json.data.totalPermainan || 0;
            }).catch(() => {});
          } catch (e) {
            // ignore
          }
        })();
    });
  </script>
</body>
</html>