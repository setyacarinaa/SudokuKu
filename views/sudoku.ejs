<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SudokuKu â€” <%= title %></title>
  <meta name="theme-color" content="#667eea">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="stylesheet" href="/css/gaya.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="navbar">
      <div class="logo">ğŸ® SudokuKu</div>
      <ul class="nav-menu">
        <li><a href="/">Beranda</a></li>
        <li><a href="/sudoku" style="color: #667eea; font-weight: bold;">Main</a></li>
        <li><a href="/leaderboard">Leaderboard</a></li>
        <li><a href="/api/logout" onclick="return confirm('Yakin ingin logout?')">Logout (<%= namaLengkap %>)</a></li>
      </ul>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Pesan Container -->
    <div id="pesan-container"></div>

    <!-- Game Card -->
    <div class="card">
      <div class="card-header text-center">
        <h1 class="card-title">ğŸ¯ Permainan Sudoku</h1>
        <p class="card-subtitle">Selesaikan puzzle dan raih skor tertinggi!</p>
      </div>

      <!-- Tingkat Kesulitan -->
      <div class="tingkat-kesulitan">
        <button id="btn-mudah" class="btn btn-secondary btn-small">Mudah</button>
        <button id="btn-sedang" class="btn btn-primary btn-small">Sedang</button>
        <button id="btn-sulit" class="btn btn-secondary btn-small">Sulit</button>
      </div>

      <!-- Timer -->
      <div class="timer" id="timer">00:00</div>

      <!-- Papan Sudoku -->
      <div id="papan-sudoku" class="papan-sudoku"></div>

      <!-- Keypad Angka -->
      <div class="keypad-angka">
        <button class="btn-keypad btn-hapus" onclick="hapusAngkaViaKeypad()" style="width: 100%; margin-bottom: 0.75rem;">
          ğŸ—‘ï¸ Hapus
        </button>
        <div class="keypad-container">
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(1)">1</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(2)">2</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(3)">3</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(4)">4</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(5)">5</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(6)">6</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(7)">7</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(8)">8</button>
          <button class="btn-keypad" onclick="inputAngkaViaKeypad(9)">9</button>
        </div>
      </div>

      <!-- Error Counter & Submit -->
      <div class="error-counter-section">
        <div class="error-counter">
          <span>âŒ Kesalahan: </span>
          <span id="error-count" class="error-count-badge">0</span>
          <span> / 3</span>
        </div>
      </div>

      <!-- Game Controls -->
      <div class="game-controls">
        <button id="btn-papan-baru" class="btn btn-primary">
          ğŸ² Puzzle Baru
        </button>
        <button id="btn-cek-jawaban" class="btn btn-secondary">
          âœ“ Cek Jawaban
        </button>
        <button id="btn-submit-jawaban" class="btn btn-success">
          âœ… Submit Jawaban Final
        </button>
        <button id="btn-reset" class="btn btn-secondary">
          ğŸ”„ Reset
        </button>
        <button id="btn-selesaikan" class="btn btn-danger">
          ğŸ“‹ Lihat Solusi
        </button>
      </div>

      <!-- Instruksi -->
      <div class="tips-section">
        <h3 class="tips-title">ğŸ’¡ Tips Bermain:</h3>
        <ul class="tips-list">
          <li>Gunakan <strong>Arrow Keys</strong> untuk navigasi antar sel</li>
          <li>Tekan <strong>Delete/Backspace</strong> untuk menghapus angka</li>
          <li>Klik tombol <strong>ğŸ’¬ Chatbot</strong> untuk bantuan realtime</li>
          <li>Ketik <strong>"hint"</strong> di chatbot untuk mendapat petunjuk</li>
          <li>Selesaikan secepat mungkin untuk skor lebih tinggi!</li>
        </ul>
      </div>
    </div>
  </main>

  <!-- Chatbot Toggle Button -->
  <button id="chatbot-toggle-btn" class="chatbot-toggle-btn" onclick="alihChatbot()">
    ğŸ’¬
  </button>

  <!-- Chatbot Container -->
  <div id="chatbot-container" class="chatbot-container chatbot-hidden">
    <div class="chatbot-header">
      <h3 style="margin: 0;">ğŸ’¬ Chatbot SudokuKu</h3>
      <button class="chatbot-toggle" id="chatbot-toggle" onclick="alihChatbot()">âœ•</button>
    </div>
    
    <div class="chatbot-quick">
      <h4>Pertanyaan cepat</h4>
      <div class="quick-list">
        <button class="btn btn-secondary btn-small" onclick="kirimPesanKeChatbot('hint')">ğŸ’¡ Minta hint</button>
        <button class="btn btn-secondary btn-small" onclick="kirimPesanKeChatbot('cek jawaban')">âœ“ Cek jawaban</button>
        <button class="btn btn-secondary btn-small" onclick="kirimPesanKeChatbot('solusi')">ğŸ“‹ Tampilkan solusi</button>
        <button class="btn btn-secondary btn-small" onclick="kirimPesanKeChatbot('cara main')">ğŸ“– Cara main</button>
        <button class="btn btn-secondary btn-small" onclick="kirimPesanKeChatbot('strategi sudoku sulit')">ğŸ§  Strategi tingkat sulit</button>
        <button class="btn btn-secondary btn-small" onclick="kirimPesanKeChatbot('apakah langkah ini benar?')">â“ Validasi langkah</button>
      </div>
    </div>
    
    <div id="chatbot-messages" class="chatbot-messages">
      <!-- Pesan akan ditambahkan di sini oleh JavaScript -->
    </div>
    
    <div class="chatbot-input">
      <form id="form-chatbot" style="display: flex; gap: 0.5rem; width: 100%;">
        <input 
          type="text" 
          id="input-chatbot" 
          placeholder="Ketik pesan atau 'hint'..." 
          autocomplete="off"
        >
        <button type="submit" class="btn btn-primary btn-small">Kirim</button>
      </form>
    </div>
  </div>

  <script>
    // Fallback binding: memastikan tombol toggle bekerja walau ada error JS lain
    (function() {
      function fallbackToggle(forceState) {
        const kontainer = document.getElementById('chatbot-container');
        const btnToggle = document.getElementById('chatbot-toggle-btn');
        if (!kontainer) return;

        const isHidden = kontainer.classList.contains('chatbot-hidden') || kontainer.style.display === 'none';
        const targetOpen = forceState === true ? true : forceState === false ? false : isHidden;

        if (targetOpen) {
          kontainer.classList.remove('chatbot-hidden');
          kontainer.style.display = 'block';
          if (btnToggle) btnToggle.classList.add('chatbot-hidden');
        } else {
          kontainer.classList.add('chatbot-hidden');
          kontainer.style.display = 'none';
          if (btnToggle) btnToggle.classList.remove('chatbot-hidden');
        }
      }

      // Jika alihChatbot belum terdefinisi (karena error muat script), pakai fallback
      if (typeof window.alihChatbot !== 'function') {
        window.alihChatbot = fallbackToggle;
      }

      // Pastikan tombol terhubung
      window.addEventListener('DOMContentLoaded', () => {
        const btnFloating = document.getElementById('chatbot-toggle-btn');
        const btnClose = document.getElementById('chatbot-toggle');

        if (btnFloating && !btnFloating.dataset.bound) {
          btnFloating.dataset.bound = '1';
          btnFloating.addEventListener('click', () => window.alihChatbot());
        }

        if (btnClose && !btnClose.dataset.bound) {
          btnClose.dataset.bound = '1';
          btnClose.addEventListener('click', () => window.alihChatbot(false));
        }
      });
    })();
  </script>

  <!-- Scripts -->
  <script src="/js/sudoku-frontend.js"></script>
  <script src="/js/chatbot-client.js"></script>
</body>
</html>
