<!DOCTYPE html>
<html lang="id">
<head>
 <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SudokuKu â€” <%= title %></title>
  <meta name="theme-color" content="#667eea">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">
  <link rel="stylesheet" href="/css/gaya.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="navbar">
      <div class="logo">ğŸ® SudokuKu</div>
      <ul class="nav-menu">
        <li><a href="/">Beranda</a></li>
        <li><a href="/sudoku">Main</a></li>
        <li><a href="/leaderboard" style="color: #667eea; font-weight: bold;">Leaderboard</a></li>
        <% if (sudahLogin) { %>
          <li><a href="/api/logout" onclick="return confirm('Yakin ingin logout?')">Logout (<%= namaLengkap %>)</a></li>
        <% } else { %>
          <li><a href="/login">Login</a></li>
        <% } %>
      </ul>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="container">
    <div class="card">
      <div class="card-header text-center">
        <h1 class="card-title">ğŸ† Leaderboard Global</h1>
        <p class="card-subtitle">Pemain terbaik berdasarkan skor tertinggi</p>
      </div>

      <!-- Filter Tingkat -->
      <div class="tingkat-kesulitan" style="margin-bottom: 2rem;">
        <button class="btn btn-primary btn-small" onclick="muatLeaderboard('semua', event)">Semua</button>
        <button class="btn btn-secondary btn-small" onclick="muatLeaderboard('mudah', event)">Mudah</button>
        <button class="btn btn-secondary btn-small" onclick="muatLeaderboard('sedang', event)">Sedang</button>
        <button class="btn btn-secondary btn-small" onclick="muatLeaderboard('sulit', event)">Sulit</button>
      </div>

      <!-- Loading -->
      <div id="loading" class="text-center" style="display: none;">
        <div class="loading"></div>
        <p style="margin-top: 1rem;">Memuat leaderboard...</p>
      </div>

      <!-- Error State -->
      <div id="error-state" class="text-center" style="display: none; padding: 1rem; color: #b91c1c; font-weight: 600;">
        Gagal memuat leaderboard. Coba refresh atau pastikan server aktif.
      </div>

      <!-- Table -->
      <div id="leaderboard-container">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Peringkat</th>
              <th>Nama Pemain</th>
              <th>Skor</th>
              <th>Waktu</th>
              <th>Tingkat</th>
              <th>Tanggal</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <!-- Data akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="text-center" style="display: none; padding: 3rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ†</div>
        <h3>Belum ada data leaderboard</h3>
        <p style="color: #6b7280; margin-top: 1rem;">Jadilah yang pertama bermain dan raih posisi teratas!</p>
      </div>
    </div>

    <!-- Info Card -->
    <div class="card" style="max-width: 1000px; margin: 2rem auto;">
      <div class="card-header text-center">
        <h2 class="card-title" style="margin-bottom: 0.5rem;">â„¹ï¸ Tentang Sistem Skor</h2>
      </div>
      <ul style="line-height: 2.2; color: #6b7280; padding: 0 1rem; font-size: 0.95rem;">
        <li><strong style="color: #667eea;">ğŸŸ¢ Mudah:</strong> Base skor <span style="background: #fee2e2; padding: 0.2rem 0.4rem; border-radius: 4px; color: #ef4444; font-weight: bold;">100 poin</span> + bonus kecepatan</li>
        <li><strong style="color: #667eea;">ğŸŸ¡ Sedang:</strong> Base skor <span style="background: #fef3c7; padding: 0.2rem 0.4rem; border-radius: 4px; color: #d97706; font-weight: bold;">200 poin</span> + bonus kecepatan</li>
        <li><strong style="color: #667eea;">ğŸ”´ Sulit:</strong> Base skor <span style="background: #dbeafe; padding: 0.2rem 0.4rem; border-radius: 4px; color: #0284c7; font-weight: bold;">300 poin</span> + bonus kecepatan</li>
        <li><strong style="color: #667eea;">âš¡ Bonus Kecepatan:</strong> Maksimal <span style="background: #d1fae5; padding: 0.2rem 0.4rem; border-radius: 4px; color: #059669; font-weight: bold;">500 poin</span> (semakin cepat = bonus lebih besar)</li>
        <li>âœ… Skor dihitung <strong>otomatis</strong> saat puzzle selesai</li>
        <li>ğŸ“Š Hanya <strong>skor terbaik</strong> yang ditampilkan di leaderboard</li>
      </ul>
    </div>
  </main>

  <!-- Scripts -->
  <script>
    let tingkatAktif = 'semua';

    // Muat leaderboard saat halaman load
    document.addEventListener('DOMContentLoaded', () => {
      muatLeaderboard('semua', null);
    });

    // Fungsi untuk muat leaderboard
    async function muatLeaderboard(tingkat = 'semua', evt = null) {
      tingkatAktif = tingkat;

      // Update tampilan tombol
      document.querySelectorAll('.tingkat-kesulitan .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      });
      
      // Jika ada event.target, update tombolnya
      if (evt && evt.target) {
        evt.target.classList.remove('btn-secondary');
        evt.target.classList.add('btn-primary');
      } else {
        // Set tombol "Semua" sebagai aktif saat page load
        const btnSemua = document.querySelector('.tingkat-kesulitan .btn');
        if (btnSemua) {
          btnSemua.classList.remove('btn-secondary');
          btnSemua.classList.add('btn-primary');
        }
      }

      // Tampilkan loading
      document.getElementById('loading').style.display = 'block';
      document.getElementById('leaderboard-container').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('error-state').style.display = 'none';

      try {
        // Request API
        const url = tingkat === 'semua' 
          ? '/api/leaderboard?limit=50' 
          : `/api/leaderboard?limit=50&tingkat=${tingkat}`;

        console.log('ğŸ”„ Loading leaderboard dari:', url);
        
        const response = await fetch(url, { credentials: 'include' });
        const data = await response.json();

        console.log('ğŸ“Š Response data:', data);

        if (data.sukses && data.data && data.data.length > 0) {
          console.log('âœ… Data ditemukan, menampilkan leaderboard');
          tampilkanLeaderboard(data.data);
          document.getElementById('leaderboard-container').style.display = 'block';
          document.getElementById('empty-state').style.display = 'none';
        } else {
          console.log('âŒ Data kosong, menampilkan empty state');
          tampilkanEmpty();
        }
      } catch (error) {
        console.error('âŒ Error memuat leaderboard:', error);
        document.getElementById('leaderboard-container').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    // Fungsi untuk menampilkan leaderboard
    function tampilkanLeaderboard(data) {
      const tbody = document.getElementById('leaderboard-body');
      tbody.innerHTML = '';

      data.forEach((item, index) => {
        const tr = document.createElement('tr');
        
        // Badge peringkat
        let badgeClass = '';
        if (item.peringkat === 1) badgeClass = 'peringkat-1';
        else if (item.peringkat === 2) badgeClass = 'peringkat-2';
        else if (item.peringkat === 3) badgeClass = 'peringkat-3';

        const badge = badgeClass 
          ? `<span class="peringkat-badge ${badgeClass}">#${item.peringkat}</span>`
          : `#${item.peringkat}`;

        // Format waktu
        const menit = Math.floor(item.waktuPenyelesaian / 60);
        const detik = item.waktuPenyelesaian % 60;
        const waktuFormat = `${menit}:${detik.toString().padStart(2, '0')}`;

        // Format tanggal
        const tanggal = new Date(item.tanggalMain).toLocaleDateString('id-ID', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        });

        tr.innerHTML = `
          <td>${badge}</td>
          <td><strong>${item.namaPengguna}</strong></td>
          <td><strong style="color: #667eea;">${item.skor}</strong></td>
          <td>${waktuFormat}</td>
          <td><span style="text-transform: capitalize;">${item.tingkatKesulitan}</span></td>
          <td>${tanggal}</td>
        `;

        tbody.appendChild(tr);
      });

      // Show container, hide empty state
      document.getElementById('leaderboard-container').style.display = 'block';
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('error-state').style.display = 'none';
    }

    // Fungsi untuk menampilkan empty state
    function tampilkanEmpty() {
      document.getElementById('leaderboard-container').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
      document.getElementById('error-state').style.display = 'none';
    }
  </script>
</body>
</html>
